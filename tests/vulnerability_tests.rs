mod common;

use axum::{
    body::Body,
    http::{Request, StatusCode},
};
use tower::ServiceExt;

// VULNERABILITY TESTS - Command Injection

#[tokio::test]
async fn test_command_injection_version_info() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/api/v1.0/version-info")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert_eq!(body["version"], "v1.0");
    assert!(body["command"].as_str().unwrap().contains("echo"));
}

#[tokio::test]
async fn test_command_injection_api_version_check() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/api/v2.0/check")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert!(body["command_executed"].as_str().unwrap().contains("uname"));
}

// VULNERABILITY TESTS - Git Repository Exposure

#[tokio::test]
async fn test_git_directory_exposure() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/.git")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert!(body["hint"].as_str().unwrap().contains("/.git/config"));
}

#[tokio::test]
async fn test_git_config_exposure() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/.git/config")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert_eq!(body["file"], "/.git/config");
    assert!(body["content"].as_str().unwrap().contains("github.com"));
}

#[tokio::test]
async fn test_git_logs_head_exposure() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/.git/logs/HEAD")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert!(body["commits"].is_array());
    assert!(body["content"].as_str().unwrap().contains("Remove hardcoded API keys"));
}

// VULNERABILITY TESTS - Swagger/OpenAPI

#[tokio::test]
async fn test_swagger_openapi_spec() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/swagger/openapi.json")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert_eq!(body["openapi"], "3.0.0");
    assert!(body["paths"].is_object());
}

#[tokio::test]
async fn test_swagger_generate_vulnerability() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/swagger/generate/title=TestAPI")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert!(body["metadata"]["validation_command"].as_str().unwrap().contains("grep"));
}

// VULNERABILITY TESTS - Environment Variable Dumps

#[tokio::test]
async fn test_v1_env_dump() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/api/v1/env")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert!(body["DATABASE_URL"].is_string());
    assert!(body["AWS_ACCESS_KEY_ID"].is_string());
    assert!(body["AWS_SECRET_ACCESS_KEY"].is_string());
    assert!(body["SECRET_KEY"].is_string());
}

#[tokio::test]
async fn test_v2_env_dump() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/api/v2/env")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert!(body["data"]["environment"]["DATABASE_URL"].is_string());
    assert!(body["data"]["environment"]["STRIPE_SECRET_KEY"].is_string());
    assert_eq!(body["meta"]["warning"], "Environment variables exposed");
}

#[tokio::test]
async fn test_v3_env_dump() {
    let app = common::create_test_app();

    let response = app
        .oneshot(
            Request::builder()
                .uri("/api/v3/env")
                .body(Body::empty())
                .unwrap(),
        )
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = common::body_to_json(response.into_body()).await;
    assert!(body["data"]["environment_variables"]["DATABASE_URL"].is_string());
    assert!(body["data"]["environment_variables"]["PRIVATE_KEY"].is_string());
    assert_eq!(body["metadata"]["severity"], "high");
    assert!(body["data"]["sensitive_count"].is_number());
}
